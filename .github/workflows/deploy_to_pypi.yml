name: Publish the completed package to Pypi

on:
  workflow_call:
    inputs:
      workflow_run_id:
        type: string
        required: true
        description: 'The ID of the workflow which triggered this workflow'
      artefact-version:
        type: string
        required: true
        description: 'the version of the artefact'


jobs:

  deploy_to_pypi_test:
    runs-on: ubuntu-latest
    environment: 
      name: 'published'
    steps:
      - name: download artefact from previous run
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.inputs.workflow_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: extract artefact
        run: |
          tar -xvf *.tar.gz
      - name: extract version from pyproject.toml
        run: |
          version=$(grep 'version =' pyproject.toml | awk '{print $3}' | sed 's/"//g')
          echo "VERSION=$version" >> $GITHUB_ENV
      - name: Publish package distributions to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/


    