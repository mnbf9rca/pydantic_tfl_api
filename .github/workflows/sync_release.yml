name: Sync Release Branch and Bump Version

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      bump_type:
        description: 'Manual version bump override (leave empty for automatic detection)'
        required: false
        type: choice
        options:
          - ''
          - major
          - minor
          - patch
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  sync_branches:
    runs-on: ubuntu-latest
    outputs:
      synced: ${{ steps.sync_result.outputs.synced }}

    steps:
      - name: Create GitHub App Token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.PUSH_APP_ID }}
          private-key: ${{ secrets.PUSH_APP_SECRET }}

      - name: Check out repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0  # Full history for proper syncing
          token: ${{ steps.app-token.outputs.token }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if release branch exists
        id: check_branch
        run: |
          if git ls-remote --heads origin release | grep -q release; then
            echo "branch_exists=true" >> $GITHUB_OUTPUT
            echo "Release branch exists"
          else
            echo "branch_exists=false" >> $GITHUB_OUTPUT
            echo "Release branch does not exist"
          fi

      - name: Create release branch (first time)
        if: steps.check_branch.outputs.branch_exists == 'false'
        run: |
          echo "## üéâ Creating Release Branch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This is the first time the release branch is being created." >> $GITHUB_STEP_SUMMARY
          echo "It will be created from the current main branch with version 2.0.0" >> $GITHUB_STEP_SUMMARY

          git checkout -b release
          git push -u origin release

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Release branch created successfully" >> $GITHUB_STEP_SUMMARY

      - name: Sync release branch with main
        if: steps.check_branch.outputs.branch_exists == 'true'
        id: sync_result
        run: |
          echo "## üîÑ Syncing Release Branch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Fetch both branches
          git fetch origin release main

          # Checkout release branch
          git checkout release

          # Get commit info
          MAIN_COMMIT=$(git rev-parse origin/main)
          RELEASE_COMMIT=$(git rev-parse release)

          echo "**Current Status:**" >> $GITHUB_STEP_SUMMARY
          echo "- Main branch: \`${MAIN_COMMIT:0:7}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Release branch: \`${RELEASE_COMMIT:0:7}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if release is already up to date
          if git merge-base --is-ancestor origin/main release; then
            echo "‚úÖ Release branch is already up to date with main" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**No sync needed.** To bump version anyway, manually trigger:" >> $GITHUB_STEP_SUMMARY
            echo "- Workflow: \`bump_version.yml\`" >> $GITHUB_STEP_SUMMARY
            echo "synced=false" >> $GITHUB_OUTPUT
          else
            # Try to merge main into release
            echo "**Attempting to merge main into release...**" >> $GITHUB_STEP_SUMMARY

            if ! git merge origin/main --no-edit; then
              echo "‚ùå Merge conflicts detected!" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Conflicting files:**" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              git diff --name-only --diff-filter=U >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "‚ö†Ô∏è Manual intervention required." >> $GITHUB_STEP_SUMMARY
              git merge --abort
              exit 1
            fi

            echo "‚úÖ Merge successful" >> $GITHUB_STEP_SUMMARY
            git push origin release

            # Show what was merged
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>üìù Commits merged</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            git log --oneline ${RELEASE_COMMIT}..origin/main >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "synced=true" >> $GITHUB_OUTPUT
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Version bump will proceed automatically" >> $GITHUB_STEP_SUMMARY

  bump_version:
    needs: sync_branches
    if: needs.sync_branches.outputs.synced == 'true'
    uses: ./.github/workflows/bump_version.yml
    with:
      bump_type: ${{ github.event.inputs.bump_type }}
    secrets: inherit
