name: Bump Version

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type (select explicitly)'
        required: true
        type: choice
        options:
          - none
          - major
          - minor
          - patch
        default: none
  workflow_call:
    inputs:
      bump_type:
        description: 'Version bump type (major, minor, or patch)'
        required: true
        type: string
    outputs:
      new_version:
        description: 'The new version number'
        value: ${{ jobs.bump_version.outputs.new_version }}

permissions:
  contents: write

jobs:
  bump_version:
    runs-on: ubuntu-latest
    environment: bump-version
    outputs:
      new_version: ${{ steps.bump_version.outputs.new_tag }}

    steps:
      - name: Create GitHub App Token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.PUSH_APP_ID }}
          private-key: ${{ secrets.PUSH_APP_SECRET }}

      - name: Check out repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 0
          ref: release
          token: ${{ steps.app-token.outputs.token }}

      - name: Set up uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv sync --group release

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version bump type
        id: determine_bump
        run: |
          echo "## ðŸ”¢ Determining Version Bump" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          USER_TYPE="${{ inputs.bump_type }}"

          # Fail if user didn't make an explicit choice
          if [ "$USER_TYPE" = "none" ] || [ -z "$USER_TYPE" ]; then
            echo "## âŒ Version Bump Type Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "You must select one of: **major**, **minor**, or **patch**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The 'none' option exists to ensure you make an explicit choice." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Validate user input
          if [[ ! "$USER_TYPE" =~ ^(major|minor|patch)$ ]]; then
            echo "âŒ Invalid bump type: $USER_TYPE" >> $GITHUB_STEP_SUMMARY
            echo "Valid options: major, minor, patch" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Always run auto-detection to establish floor
          echo "**Auto-detecting minimum bump from dependency changes...**" >> $GITHUB_STEP_SUMMARY
          AUTO_TYPE=$(uv run --group release bash scripts/determine-version-bump.sh)

          # Validate auto-detected type
          if [[ ! "$AUTO_TYPE" =~ ^(major|minor|patch)$ ]]; then
            echo "âŒ Auto-detection returned invalid bump type: $AUTO_TYPE" >> $GITHUB_STEP_SUMMARY
            echo "This is an internal error. Please check the determine-version-bump.sh script." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "**Auto-detected minimum:** \`$AUTO_TYPE\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "**User selected:** \`$USER_TYPE\`" >> $GITHUB_STEP_SUMMARY

          # Determine final bump type: use the higher of auto-detected and user-selected
          # Priority: major > minor > patch
          # Auto-detection sets the floor, user can only go higher
          bump_priority() {
            case "$1" in
              major) echo 3 ;;
              minor) echo 2 ;;
              patch) echo 1 ;;
              *) echo 0 ;;
            esac
          }

          AUTO_PRIORITY=$(bump_priority "$AUTO_TYPE")
          USER_PRIORITY=$(bump_priority "$USER_TYPE")

          if [ "$USER_PRIORITY" -ge "$AUTO_PRIORITY" ]; then
            BUMP_TYPE="$USER_TYPE"
            if [ "$USER_PRIORITY" -gt "$AUTO_PRIORITY" ]; then
              echo "**Result:** Using user selection \`$BUMP_TYPE\` (higher than auto-detected minimum)" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Result:** Using \`$BUMP_TYPE\` (matches auto-detected minimum)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## âŒ Version Bump Too Low" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "You selected \`$USER_TYPE\` but the auto-detected minimum is \`$AUTO_TYPE\`." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please re-run the workflow with at least \`$AUTO_TYPE\` selected." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

      - name: Bump version and create tag
        id: bump_version
        uses: anothrNick/github-tag-action@4ed44965e0db8dab2b466a16da04aec3cc312fd8
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          WITH_V: false
          DEFAULT_BUMP: ${{ steps.determine_bump.outputs.bump_type }}
          RELEASE_BRANCHES: release
          DRY_RUN: false

      - name: Update pyproject.toml with new version
        run: |
          NEW_VERSION="${{ steps.bump_version.outputs.new_tag }}"

          echo "**Setting version in pyproject.toml to \`$NEW_VERSION\`**" >> $GITHUB_STEP_SUMMARY

          # Update version in pyproject.toml using Python script
          uv run --group release python scripts/update_pyproject_version.py "$NEW_VERSION"

          # Commit the version change
          git add pyproject.toml
          git commit -m "chore: bump version to $NEW_VERSION"

          # Push the changes
          git push origin release

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Version Bumped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**New version:** \`$NEW_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "**Git tag:** \`$NEW_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment workflow will now trigger automatically." >> $GITHUB_STEP_SUMMARY
